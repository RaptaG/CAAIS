#!/bin/bash
# Made by RaptaG, terminalmaid and TruncatedDinosour

# Definitions
ver="2.0-dev.2"
fname="$(basename $0)"
appendInPacmanConf="$(grep 'chaotic-aur' /etc/pacman.conf)"
isVanillaArch="$(grep 'ID=arch' /etc/os-release)"
isArchBased="$(grep 'ID_LIKE=arch' /etc/os-release)"
isArtix="$(grep 'ID=artix' /etc/os-release)"
AURreinstall="$(pacman -Qm | awk '{print $1}')"

startup() {
     echo "CAAIS, version ${ver}"
     echo "Current operation: ${action} Chaotic-AUR"
}

# Check if the OS is (based on) Arch Linux
if [ "${isArchBased}" == "" ]; then
     echo "Error: Your system is not (based on) Arch Linux. Chaotic-AUR cannot be installed."
     exit 1
elif [ "${isArtix}" == "ID=artix" ]; then
     sleep 0s
elif [ "${isVanillaArch}" == "ID=arch" ]; then
     sleep 0s
fi

# Root permission checker
if [ "${EUID}" -ne 0 ]; then
     echo -e "Error: Root permissions are required for ${fname} to work.\nPlease run 'sudo ./${fname} --help' for more information."
     exit 1
fi

# Download & install Chaotic-AUR
install() {
     startup
     echo -n "Do you wish to proceed [Y/n] "
     read answer
     
     case "${answer}" in
     [nN])
          exit 0
          ;;
     *)
          unset answer
          ;;
     esac

     # Key
     echo "Installing the key..."
     pacman-key --recv-key FBA220DFC880C036 --keyserver keyserver.ubuntu.com > /dev/null 2>&1
     pacman-key --lsign-key FBA220DFC880C036 > /dev/null 2>&1

     # Keyring & mirrorlist
     echo "Downloading the keyring..."
     pacman -U 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst' --noconfirm > /dev/null 2>&1

     echo "Downloading the mirrorlist..."
     pacman -U 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst' --noconfirm > /dev/null 2>&1

     # Append in pacman.conf
     if [ "${appendInPacmanConf}" == "[chaotic-aur]" ]; then
          echo "Chaotic-AUR is already append in pacman.conf, skipping..."
     else
          echo "Appending Chaotic-AUR in pacman.conf..."
          echo -e "\r\n[chaotic-aur]\nInclude = /etc/pacman.d/chaotic-mirrorlist" >> /etc/pacman.conf
     fi

     # Refresh mirrorlists
     echo "Refreshing the mirrorlists..."
     pacman -Sy > /dev/null 2>&1

     # Finish
     echo "Done! Now Chaotic-AUR should be installed and working in your system!"
     exit 0
}

# Uninstall Chaotic-AUR
remove() {     
     startup
     echo -n "Do you wish to proceed? [y/N] "
     read answer
     
     case "${answer}" in
     [yY])
          unset answer
          ;;
     *)
          exit 0
          ;;
     esac

     # Key
     echo "Deleting the key..."
     pacman-key --delete 3FFA0B5E092ED4095E26F69B8ADB4AEC585061CF > /dev/null 2>&1

     # Keyring & mirrorlist
     echo "Uninstalling the keyring..."
     pacman -Rns chaotic-keyring --noconfirm > /dev/null 2>&1

     echo "Uninstalling the mirrorlist..."
     pacman -Rns chaotic-mirrorlist --noconfirm > /dev/null 2>&1

     # Remove from pacman.conf
     echo "Removing Chaotic-AUR from pacman.conf..."
     sed -i '/chaotic-aur/d' /etc/pacman.conf
     sed -i '/chaotic-mirrorlist/d' /etc/pacman.conf

     # Refresh mirrorlists
     echo "Refreshing the mirrorlists..."
     pacman -Sy > /dev/null 2>&1

     # AUR convertion
     echo "Chaotic-AUR has been removed and all the packages you had installed from it are not working anymore."
     echo -n "Do you wish to reinstall them from AUR? [Y/n] "
     read answer

     case "${answer}" in
     [nN])
          exit 0
          ;;
     *)
          unset answer
          ;;
     esac

     echo "Reinstalling..."
     pamac build ${AURreinstall} --no-confirm > /dev/null 2>&1

     # Finish 
     echo "Done! Now, all your Chaotic-AUR packages have now been reinstalled and working again, with Chaotic-AUR removed from your system!"
     exit 0
}

# Find the option selected and run the correct command
case "$1" in
-h | --help | "")
     echo "Usage: ${fname} [OPTION]"
     echo
     echo "-h, --help                        This help menu"
     echo
     echo "-a, --about                       Display informaton about CAAIS (eg. version)"
     echo
     echo "-i, --install                     Download and install Chaotic-AUR"
     echo
     echo "-r, --remove                      Remove Chaotic-AUR from your system"
     echo
     echo "The main repo with the source code, the license and all the info related is availiable here:"
     echo "https://github.com/RaptaG/CAAIS"
     exit 0
     ;;
-a | --about)
     echo "Version of CAAIS currently used: ${ver}"
     echo "GitHub release: https://github.com/RaptaG/CAAIS/releases/tag/${ver}"
     echo
     echo "Current contributors:"
     echo "1) RaptaG (Main developer)"
     echo "2) terminalmaid (Pull Request #1)"
     echo "3) TruncatedDinosour (Pull Request #2)"
     exit 0
     ;;
-i | --install)
     action="Install"
     install
     ;;
-r | --remove)
     action="Remove"
     remove
     ;;
*)
     echo "Invalid option '$1'. Please run 'sudo ./$fname' to see the list of all the options availiable."
     exit 1
     ;;
esac
