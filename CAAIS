#!/bin/bash
# Made by RaptaG, terminalmaid and TruncatedDinosour

# Definitions
ver="1.9"
fname="$(basename $0)"
appendInPacmanConf=$(grep 'chaotic-aur' /etc/pacman.conf)
isArchBased="$(grep 'ID_LIKE=arch' /etc/os-release)"
isArtix="$(grep 'ID=artix' /etc/os-release)"
isInstalled="$(pacman -Q chaotic-keyring chaotic-mirrorlist | awk '{print $1}')"

startup() {
     echo "CAAIS, version $ver"
     echo "Current operation: $action Chaotic-AUR"
}

# Check if the OS is based on Arch Linux/ is Artix Linux
if [ "$isArchBased" == "" ]; then
     echo "Error: Your system is not (based on) Arch Linux. Chaotic-AUR cannot be installed."
     exit 1
elif [ "isArtix" == "ID=artix" ]; then
     sleep 0s
fi

# Root permission checker
if [ "$EUID" -ne 0 ]; then
     echo -e "Error: Root permissions are required for $fname to work.\nPlease run 'sudo ./$fname --help' for more information."
     exit 1
fi

# Download & install Chaotic-AUR
install() {
     startup

     # Checks
     if [ "$isInstalled" == "chaotic-keyring
     chaotic-mirrorlist" ]; then
          echo "Error: Chaotic-AUR is alread installed and it's pointless to be reinstalled."
          exit 1
     fi

     echo -n "Do you wish to proceed [Y/n] "
     read answer

     if [ "$answer" == "n" ]; then
          exit 0
     elif [ "$answer" == "N" ]; then
          exit 0
     fi
     unset answer

     # Key
     echo "Installing the key..."
     pacman-key --recv-key FBA220DFC880C036 --keyserver keyserver.ubuntu.com > /dev/null 2>&1
     pacman-key --lsign-key FBA220DFC880C036 > /dev/null 2>&1

     # Keyring & mirrorlist
     echo "Downloading the keyring..."
     pacman -U 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst' --noconfirm > /dev/null 2>&1

     echo "Downloading the mirrorlist..."
     pacman -U 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst' --noconfirm > /dev/null 2>&1

     # Append in pacman.conf
     if [ "$appendInPacmanConf" == "[chaotic-aur]" ]; then
          echo "Chaotic-AUR is already append in pacman.conf, skipping..."
     else
          echo "Appending Chaotic-AUR in pacman.conf..."
          echo -e "\r\n[chaotic-aur]\nInclude = /etc/pacman.d/chaotic-mirrorlist" >> /etc/pacman.conf
     fi

     # Refresh mirrorlists
     echo "Refreshing the mirrorlists..."
     pacman -Sy > /dev/null 2>&1

     # Finish
     echo "Done! Now Chaotic-AUR should be installed and working in your system!"
     exit 0
}

# Uninstall Chaotic-AUR
remove() {     
     startup

     # Checks
     if [ "$isInstalled" == "error: package 'chaotic-keyring' was not found
     error: package 'chaotic-mirrorlist' was not found" ]; then
          echo "Error: Chaotic-AUR is not installed and cannot be removed."
          exit 1
     fi

     echo -n "This will break ALL the packages you may have installed with Chaotic-AUR. Do you wish to proceed? [y/N] "
     read answer

     if [ "$answer" == "n" ]; then
          exit 0
     elif [ "$answer" == "N" ]; then
          exit 0
     elif [ "$answer" == "" ]; then
          exit 0
     fi
     unset answer

     # Key
     echo "Deleting the key..."
     pacman-key --delete 3FFA0B5E092ED4095E26F69B8ADB4AEC585061CF > /dev/null 2>&1

     # Keyring & mirrorlist
     echo "Uninstalling the keyring..."
     pacman -Rns chaotic-keyring --no-confirm > /dev/null 2>&1

     echo "Uninstalling the mirrorlist..."
     pacman -Rns chaotic-mirrorlist --no-confirm > /dev/null 2>&1

     # Remove from pacman.conf
     echo "Removing Chaotic-AUR from pacman.conf..."
     sed -i '/chaotic-aur/d' /etc/pacman.conf
     sed -i '/chaotic-mirrorlist/d' /etc/pacman.conf

     # Refresh mirrorlists
     echo "Refreshing the mirrorlists..."
     pacman -Sy > /dev/null 2>&1

     # Finish
     echo "Done! Now Chaotic-AUR should be removed from your system."
     exit 0
}

# Find the option selected and run the correct command
case "$1" in
-h | --help | "")
     echo -e "Usage: $fname [OPTION]"
     echo -e "\n-h, --help                   This help menu"
     echo -e "\n-a, --about                  Display informaton about CAAIS (eg. version)"
     echo -e "\n-i, --install                Download and install Chaotic-AUR"
     echo -e "\n-r, --remove                 Remove Chaotic-AUR from your system"
     echo -e "\nThe main repo with the source code, the license and all the info related is availiable here:\nhttps://github.com/RaptaG/CAAIS"
     ;;
-a | --about)
     echo "Version of CAAIS currently used: $ver"
     echo -e "GitHub release: https://github.com/RaptaG/CAAIS/releases/tag/$ver\n"
     echo "Current contributors:"
     echo "1) RaptaG (main developer)"
     echo "2) terminalmaid (Pull Request #1)"
     echo "3) TruncatedDinosour (Pull Request #2)"
     ;;
-i | --install)
     action="Install"
     install
     ;;
-r | --remove)
     action="Remove"
     remove
     ;;
*)
     echo "Invalid option '$1'. Please run 'sudo ./$fname' to see the list of all the options availiable."
     exit 1
     ;;
esac
