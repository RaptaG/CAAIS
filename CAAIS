#!/usr/bin/env bash

# Definitions
ver="2.1"
fname="$(basename $0)"
appendInPacmanConf="$(grep 'chaotic-aur' /etc/pacman.conf)"
isArchBased="$(grep 'ID_LIKE=arch' /etc/os-release | awk -F 'ID_LIKE=' '{print $2}')"
isException="$(grep 'ID=' /etc/os-release | awk -F 'ID=' '{print $2}')"
foreignChaoticAURpacks="$(pacman -Qm | awk '{print $1}')"

function startup() {
     echo "CAAIS, version ${ver}"
     echo "Current operation: ${action} Chaotic-AUR"
}

function rootCheck() {
     if [ "${EUID}" -ne 0 ]; then
          echo "Error: Root permissions are required for ${fname} to work."
          echo "Please run './${fname}' for more information."
          exit 1
     fi
}

function installCheck() {
     if [ "$(find /etc/pacman.d/ -name chaotic-mirrorlist)" == "/etc/pacman.d/chaotic-mirrorlist" ]; then
          isInstalled="true"
     else
          isInstalled="false"
     fi
}

# Check if the distro is (based on) Arch Linux
case ${isException} in
arch | artix)
     sleep 0s
     ;;
*)
     if [ "${isArchBased}" != "arch" ]; then
          echo "Error: Your system is not (based on) Arch Linux. Chaotic-AUR cannot be installed."
          exit 1
     fi
     ;;
esac

# Download & install Chaotic-AUR
function install() {
     startup

     installCheck
     if [ "${isInstalled}" != "false" ]; then
          echo -e "\nError: Chaotic-AUR is already installed."
          exit 1
     fi

     echo -n "Do you wish to proceed [Y/n] "
     read answer
     
     case "${answer}" in
     [nN])
          exit 0
          ;;
     *)
          unset answer
          ;;
     esac

     # Key
     echo "Installing the key..."
     pacman-key --recv-key FBA220DFC880C036 --keyserver keyserver.ubuntu.com > /dev/null 2>&1
     pacman-key --lsign-key FBA220DFC880C036 > /dev/null 2>&1

     # Keyring & mirrorlist
     echo "Downloading the keyring..."
     pacman -U 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst' --noconfirm > /dev/null 2>&1

     echo "Downloading the mirrorlist..."
     pacman -U 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst' --noconfirm > /dev/null 2>&1

     # Append in pacman.conf
     if [ "${appendInPacmanConf}" != "[chaotic-aur]" ]; then
          echo "Appending Chaotic-AUR in pacman.conf..."
          echo -e "\r\n[chaotic-aur]\nInclude = /etc/pacman.d/chaotic-mirrorlist" >> /etc/pacman.conf
     fi

     # Refresh mirrorlists
     echo "Refreshing the mirrorlists..."
     pacman -Sy > /dev/null 2>&1

     # Finish
     echo "Chaotic-AUR has been successfully installed!"
     exit 0
}

# Uninstall Chaotic-AUR
function remove() {     
     startup

     installCheck
     if [ "${isInstalled}" != "true" ]; then
          echo -e "\nError: Chaotic-AUR is already uninstalled."
          exit 1
     fi

     echo -n "Do you wish to proceed? [y/N] "
     read answer
     
     case "${answer}" in
     [yY])
          unset answer
          ;;
     *)
          exit 0
          ;;
     esac

     # Key
     echo "Deleting the key..."
     pacman-key --delete 3FFA0B5E092ED4095E26F69B8ADB4AEC585061CF > /dev/null 2>&1

     # Keyring & mirrorlist
     echo "Uninstalling the keyring..."
     pacman -Rns chaotic-keyring --noconfirm > /dev/null 2>&1

     echo "Uninstalling the mirrorlist..."
     pacman -Rns chaotic-mirrorlist --noconfirm > /dev/null 2>&1

     # Remove from pacman.conf
     echo "Removing Chaotic-AUR from pacman.conf..."
     sed -i '/chaotic-aur/d' /etc/pacman.conf
     sed -i '/chaotic-mirrorlist/d' /etc/pacman.conf

     # Refresh mirrorlists
     echo "Refreshing the mirrorlists..."
     pacman -Sy > /dev/null 2>&1

     # AUR convertion
     echo -n "Do you wish to reinstall your old Chaotic-AUR packages from AUR? [Y/n] "
     read answer

     case "${answer}" in
     [nN])
          echo :"Chaotic-AUR has been successfully removed!"
          exit 0
          ;;
     *)
          unset answer
          ;;
     esac

     echo "Reinstalling..."
     pamac build ${foreignChaoticAURpacks} --no-confirm > /dev/null 2>&1

     # Finish 
     echo "Chaotic-AUR has been successfully removed and all your Chaotic-AUR packages have been reinstalled!"
     exit 0
}

# Find the option selected and run the correct command
case "$1" in
-h | help | "")
     echo "Usage: ${fname} [OPTION]"
     echo
     echo "-h, --help                        This help menu"
     echo
     echo "-a, --about                       Display informaton about CAAIS"
     echo
     echo "-i, --install                     Download and install Chaotic-AUR"
     echo
     echo "-r, --remove                      Remove Chaotic-AUR from your system"
     echo
     echo "The main repo with the source code, the license and all the info related is availiable here:"
     echo "https://github.com/RaptaG/CAAIS"
     exit 0
     ;;
-a | about)
     echo "Version of CAAIS currently used: ${ver}"
     echo "GitHub release: https://github.com/RaptaG/CAAIS/releases/tag/${ver}"
     echo
     echo "Current contributors:"
     echo "1) RaptaG (Main developer)"
     echo "2) terminalmaid (Pull Request #1)"
     echo "3) TruncatedDinosour (Pull Request #2)"
     echo
     echo "Copyright Â© 2022 RaptaG"
     echo
     echo 'Licensed under the Apache License, Version 2.0 (the "License");'
     echo "you may not use this file except in compliance with the License."
     echo "You may obtain a copy of the License at"
     echo
     echo "      http://www.apache.org/licenses/LICENSE-2.0"
     echo
     echo "Unless required by applicable law or agreed to in writing, software"
     echo 'distributed under the License is distributed on an "AS IS" BASIS,'
     echo "WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied."
     echo "See the License for the specific language governing permissions and"
     echo "limitations under the License."
     exit 0
     ;;
-i | install)
     rootCheck
     action="Install"
     install
     ;;
-r | remove)
     rootCheck
     action="Remove"
     remove
     ;;
*)
     echo "Invalid option '$1'. Please run './${fname}' to see the list of all the options availiable."
     exit 1
     ;;
esac
